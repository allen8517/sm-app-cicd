name: Build Android/iOS/Orca App 1101

on:
  push:
    branches:
      - 'main'

  pull_request:
    branches:
      - '*'

  workflow_dispatch:
    inputs:
      build-mode:
        description: 'build-mode of build to run (profile | release-testing | release ), profile æ”¯æŒæŠ“åŒ…å’Œåˆ‡æ¢ç¯å¢ƒ, release-testing æ”¯æŒä¸Šä¼ åˆ°TestFlight, release æ”¯æŒä¸Šä¼ åˆ°App Store, ã€ release-testing åªæœ‰iOSæ‰æœ‰ï¼ŒAndroidå’ŒOrcaæ²¡æœ‰release-testingæ¨¡å¼ ã€‘'
        required: true
        type: choice
        options:
          - profile
          - release-testing
          - release
        default: 'profile'
    
      build-env:
        description: 'build-env of build to run (prod, staging, dev)'
        required: true
        type: choice
        options:
          - prod
          - pre
          - staging
          - dev
        default: 'prod'

      build-language:
        description: 'i18n (en-US, zh-CN)'
        required: true
        type: choice
        options:
          - en-US
          - zh-CN
        default: 'en-US'

      build-platform:
        description: 'Platform (android&ios&orca, android&ios, android, ios, orca)'
        required: true
        type: choice
        options:
          - android&ios&orca
          - android&ios
          - android
          - ios
          - orca
        default: 'android&ios&orca'
jobs:
  ios-build:
    name: iOS æ„å»º
    if: ${{ contains(github.event.inputs.build-platform, 'ios') }}
    runs-on: macos-latest
    steps:

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # è®¾ç½® Flutter ç¯å¢ƒ
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
    
      # åœ¨æ„å»ºä¹‹å‰æ‰§è¡Œ flutter clean
      - name: Flutter æ¸…ç†
        run: flutter clean

      - name: Flutter ç‰ˆæœ¬
        run: flutter --version

      # flutter pub upgrade / flutter pub get
      - name: å®‰è£…ä¾èµ–
        run: |
          flutter pub upgrade
          flutter pub get
      
      - name: è®¾ç½®é»˜è®¤æ„å»ºç±»å‹
        run: |
          # è®¾ç½®æ„å»ºæ¨¡å¼ï¼Œå¦‚æœè¾“å…¥ä¸º release-testing åˆ™ä½¿ç”¨ releaseï¼Œå¦åˆ™ä½¿ç”¨è¾“å…¥å€¼æˆ–é»˜è®¤å€¼
          BUILD_MODE_INPUT="${{ github.event.inputs.build-mode || 'release' }}"
          echo "BUILD_MODE_INPUT=$BUILD_MODE_INPUT" >> $GITHUB_ENV
          if [[ "$BUILD_MODE_INPUT" == "release-testing" ]]; then
            echo "BUILD_MODE=release" >> $GITHUB_ENV
          else
            echo "BUILD_MODE=$BUILD_MODE_INPUT" >> $GITHUB_ENV
            # å…¶ä»–é…ç½®åœ¨åç»­æ­¥éª¤ä¸­è®¾ç½®
          fi
              
      - name: è®¾ç½®é»˜è®¤æ„å»ºè¯­è¨€
        run: |
            echo "BUILD_LOCALE=${{ github.event.inputs.build-language || 'en-US' }}" >> $GITHUB_ENV
      
      - name: è®¾ç½®é»˜è®¤æ„å»ºç¯å¢ƒ
        run: |
            echo "BUILD_ENV=${{ github.event.inputs.build-env || 'prod' }}" >> $GITHUB_ENV
   
      - name: è·å–ç¯å¢ƒå˜é‡
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}
        run: |
          echo "BUILD_MODE=$BUILD_MODE, BUILD_MODE_INPUT=$BUILD_MODE_INPUT, BUILD_ENV=$BUILD_ENV, BUILD_LOCALE=$BUILD_LOCALE"

      # Set up Apple Certificate and Profile for signing
      - name: è®¾ç½®ç­¾åè¯ä¹¦å’Œé…ç½®æ–‡ä»¶
        uses: apple-actions/import-codesign-certs@v3
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          keychain: 'signing_temp'
          keychain-password: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
      
      - name: æ ¹æ®æ„å»ºç±»å‹è®¾ç½®é…ç½®æ–‡ä»¶
        id: set_profile
        env:
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
          BUILD_MODE: ${{ env.BUILD_MODE }}
        run: |
            echo "BUILD_MODE_INPUT=${{ env.BUILD_MODE_INPUT }}, BUILD_MODE=${{ env.BUILD_MODE }}"
            if  [[ "$BUILD_MODE_INPUT" == "profile" ]]; then
              echo "IOS_PROVISIONING_PROFILE=${{ secrets.IOS_PROVISIONING_PROFILE }}" >> $GITHUB_ENV
              echo "EXPORT_OPTIONS_PLIST=ExportOptions_release_testing.plist" >> $GITHUB_ENV
              echo "IOS_MOBILE_PROVISION_NAME=snapmakerAppAdhoc" >> $GITHUB_ENV
              echo "BUILD_CONFIGURATION=Profile" >> $GITHUB_ENV
            elif [[ "$BUILD_MODE_INPUT" == "release-testing" ]]; then
              echo "IOS_PROVISIONING_PROFILE=${{ secrets.IOS_PROVISIONING_PROFILE }}" >> $GITHUB_ENV
              echo "EXPORT_OPTIONS_PLIST=ExportOptions_release_testing.plist" >> $GITHUB_ENV
              echo "IOS_MOBILE_PROVISION_NAME=snapmakerAppAdhoc" >> $GITHUB_ENV
              echo "BUILD_CONFIGURATION=Release" >> $GITHUB_ENV
            elif [[ "$BUILD_MODE_INPUT" == "release" ]]; then
              echo "IOS_PROVISIONING_PROFILE=${{ secrets.IOS_PROVISIONING_PROFILE_APPSTORE }}" >> $GITHUB_ENV
              echo "EXPORT_OPTIONS_PLIST=ExportOptions_release.plist" >> $GITHUB_ENV
              echo "IOS_MOBILE_PROVISION_NAME=snapmakerAppAppstore" >> $GITHUB_ENV
              echo "BUILD_CONFIGURATION=Release" >> $GITHUB_ENV
            else
              echo "BUILD_MODE_INPUT is not profile, release-testing, release, debug"
              echo "BUILD_MODE_INPUT=$BUILD_MODE_INPUT is not valid"
              exit 1
            fi

      # å®‰è£…æè¿°æ–‡ä»¶
      - name: å®‰è£… Apple é…ç½®æ–‡ä»¶
        # é€šè¿‡ env ä¼ é€’ GitHub Secrets IOS_PROVISIONING_PROFILEä½¿ç”¨adhoc/releaseæ–‡ä»¶  IOS_PROVISIONING_PROFILE_APPSTORE   IOS_PROVISIONING_PROFILE
        env:
          IOS_PROVISIONING_PROFILE: ${{ env.IOS_PROVISIONING_PROFILE }}
          IOS_MOBILE_PROVISION_NAME:  ${{ env.IOS_MOBILE_PROVISION_NAME }}
        run: |
          echo "*****Decoding $IOS_MOBILE_PROVISION_NAMETE Apple Provisioning Profile"
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > /tmp/$IOS_MOBILE_PROVISION_NAME.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/$IOS_MOBILE_PROVISION_NAME.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
     
      # æ£€æŸ¥è¯ä¹¦æ˜¯å¦æœ‰æ•ˆ
      - name: æ£€æŸ¥ Apple è¯ä¹¦
        run: |
          echo "ğŸ” æ£€æŸ¥æœ‰æ•ˆçš„ä»£ç ç­¾åè¯ä¹¦..."
          CERT_COUNT=$(security find-identity -v -p codesigning | grep -c "valid identities found")
          if [ "$CERT_COUNT" -eq 0 ]; then
            echo "âŒ æœªæ‰¾åˆ°æœ‰æ•ˆçš„ä»£ç ç­¾åè¯ä¹¦"
            exit 1
          else
            echo "âœ… æ‰¾åˆ° $CERT_COUNT ä¸ªæœ‰æ•ˆçš„ä»£ç ç­¾åè¯ä¹¦"
          fi

          
      - name: å®‰è£… Pods
        # run: pod install --no-repo-update
        run: |
          echo "Clean Pods"
          rm -rf Podfile.lock Pods .symlinks
          echo "Update pod repo"
          pod repo update
          echo "Install Pods"
          pod install
        working-directory: ios
          

      - name: Flutter æ„å»º IPA å¹¶å¯¼å‡º iOS IPA
        run: |
          echo "flutter build ipa --$BUILD_MODE --export-options-plist=ios/$EXPORT_OPTIONS_PLIST --dart-define=env=$BUILD_ENV--dart-define=locale=$BUILD_LOCALE"
          flutter build ipa --$BUILD_MODE --export-options-plist=ios/$EXPORT_OPTIONS_PLIST --dart-define=env=$BUILD_ENV--dart-define=locale=$BUILD_LOCALE
          # éå†./build/ios/archive
          ls -l ./build/ios/archive
          echo "ARCHIVE_PATH=./build/ios/archive" >> $GITHUB_ENV
          echo "IOS_IPA_PATH=./build/ios/ipa/Snapmaker.ipa" >> $GITHUB_ENV
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}
          EXPORT_OPTIONS_PLIST: ${{ env.EXPORT_OPTIONS_PLIST }}
    
      # # è¾“å‡ºdSYMs.zipæ–‡ä»¶
      # - name: Export dSYMs.zip
      #   if: ${{ env.BUILD_MODE != 'release' }}
      #   env:
      #     BUILD_MODE: ${{ env.BUILD_MODE }}
      #     ARCHIVE_PATH: ${{ env.ARCHIVE_PATH }}
      #   run: |
      #     DSYMS_ZIP_PATH="${{ github.workspace }}/build/ios/archive/dSYMs.zip"
      #     echo "DSYMS_ZIP_PATH=$DSYMS_ZIP_PATH" >> $GITHUB_ENV
      #     cd ./build/ios/archive
      #     zip -r $DSYMS_ZIP_PATH dSYMs
          
      # # è¾“å‡ºdSYMs.zipæ–‡ä»¶
      # - name: Upload dSYMs.zip to github
      #   if: ${{ env.BUILD_MODE != 'release' }}
      #   env: 
      #     BUILD_MODE: ${{ env.BUILD_MODE }}
      #     DSYMS_ZIP_PATH: ${{ env.DSYMS_ZIP_PATH }}
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: dSYMs-from-xcarchive
      #     path: "${{ env.DSYMS_ZIP_PATH }}"

      - name: ä¸Šä¼  iOS æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        env: 
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}
          EXPORT_OPTIONS_PLIST: ${{ env.EXPORT_OPTIONS_PLIST }}
          IOS_PROVISIONING_PROFILE: ${{ env.IOS_PROVISIONING_PROFILE }}
          IOS_MOBILE_PROVISION_NAME:  ${{ env.IOS_MOBILE_PROVISION_NAME }}
          IOS_IPA_PATH: ${{ env.IOS_IPA_PATH }}
        with:
          name: iOS-${{ env.BUILD_MODE }}-${{ env.BUILD_ENV }}-${{ env.BUILD_LOCALE }}-ipa
          path: ${{ env.IOS_IPA_PATH }}
          #path: ./build/ios/ipa/Snapmaker.ipa
      
      # security delete-keychain signing_temp.keychain-db
      - name: æ¸…ç†å¯†é’¥é“¾å’Œé…ç½®æ–‡ä»¶
        if: ${{ always() }}
        env:
            IOS_MOBILE_PROVISION_NAME:  ${{ env.IOS_MOBILE_PROVISION_NAME }}
        run: |
          rm ~/Library/MobileDevice/Provisioning\ Profiles/$IOS_MOBILE_PROVISION_NAME.mobileprovision
          security delete-keychain signing_temp.keychain-db

      # ä».xcarchiveæ–‡ä»¶ä¸­å°†dSYMsæ–‡ä»¶å¤¹å¤åˆ¶åˆ°dSYMs.zip
      - name: ä¸Šä¼  dSYMs.zip åˆ° Firebase
        if: ${{ env.BUILD_MODE == 'release' }}
        run: |
          # åˆ¤æ–­ARCHIVE_PATHæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f $ARCHIVE_PATH ]; then
            chmod +x "${PROJECT_DIR}/ios/upload-symbols.sh"
            bash "${PROJECT_DIR}/ios/upload-symbols.sh"
          else
            echo "ARCHIVE_PATH file does not exist"
          fi
        env:
          PROJECT_DIR: ${{ github.workspace }}
          UPLOAD_FIREBASE_DSYM: true
          ARCHIVE_PATH: ${{ env.ARCHIVE_PATH }}
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}

      
      - name: è®¾ç½® App Store Connect API å¯†é’¥
        if: ${{ env.BUILD_MODE_INPUT == 'release '}}
        env: 
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
        run: |
          echo "API Key ID: ${{ secrets.APPSTORE_API_KEY_ID }}"
          echo "API Issuer ID: ${{ secrets.APPSTORE_ISSUER_ID }}"
          mkdir -p ~/private_keys
          echo "${{ secrets.APPSTORE_API_PRIVATE_KEY }}" > ~/private_keys/AuthKey_${{ secrets.APPSTORE_API_KEY_ID }}.p8
          chmod 600 ~/private_keys/AuthKey_${{ secrets.APPSTORE_API_KEY_ID }}.p8
      
      # - name: Upload to App Store
      #   if: env.BUILD_MODE_INPUT == 'release'
      #   run: |
      #     xcrun altool --upload-app -f ${{ env.IOS_IPA_PATH }} -type ios --apiKey ${{ secrets.APPSTORE_API_KEY_ID }} --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }} --verbose

      - name: ä¸Šä¼ åˆ° TestFlightï¼ˆå¦‚æœæ˜¯æµ‹è¯•ç‰ˆï¼‰
        if: ${{ env.BUILD_MODE_INPUT == 'release'}}
        env: 
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: ${{ env.IOS_IPA_PATH }}
          issuer-id: ${{ secrets.APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.APPSTORE_API_KEY_ID }}
          api-private-key: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      
  android-build:
    name: Android æ„å»º
    if: ${{ contains(github.event.inputs.build-platform, 'android') }}
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:

      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
    
      # è®¾ç½®javaç¯å¢ƒ
      - name: è®¾ç½® Android æ„å»ºçš„ Java ç¯å¢ƒ
        uses: actions/setup-java@v4
        with:
            distribution: 'temurin'
            java-version: '17'

      # è®¾ç½® Flutter ç¯å¢ƒ
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
            flutter-version: '3.24.0'

      - run: flutter --version

      # åœ¨æ„å»ºä¹‹å‰æ‰§è¡Œ flutter clean rm -f ios/Podfile.lock
      - name: Flutter æ¸…ç†
        run: flutter clean

      # flutter pub get
      - name: å®‰è£…ä¾èµ–
        run: flutter pub get
    
        # # è¿è¡Œ Flutter åˆ†æ (å¯é€‰ï¼Œç¡®ä¿ä»£ç ç¬¦åˆ Dart è§„èŒƒ)
        # - name: Run Flutter analyze
        #   run: flutter analyze

        # # è¿è¡Œ Flutter æµ‹è¯• (å¯é€‰)
        # - name: Run Flutter tests
        #   run: flutter test
      - name: è®¾ç½®é»˜è®¤æ„å»ºç±»å‹
        run: |
          # è®¾ç½®æ„å»ºæ¨¡å¼ï¼Œå¦‚æœè¾“å…¥ä¸º release-testing åˆ™ä½¿ç”¨ releaseï¼Œå¦åˆ™ä½¿ç”¨è¾“å…¥å€¼æˆ–é»˜è®¤å€¼
          BUILD_MODE_INPUT="${{ github.event.inputs.build-mode || 'release' }}"
          echo "BUILD_MODE_INPUT=$BUILD_MODE_INPUT" >> $GITHUB_ENV
          if [[ "$BUILD_MODE_INPUT" == "release-testing" ]]; then
            echo "BUILD_MODE=release" >> $GITHUB_ENV
          else
            echo "BUILD_MODE=$BUILD_MODE_INPUT" >> $GITHUB_ENV
            # å…¶ä»–é…ç½®åœ¨åç»­æ­¥éª¤ä¸­è®¾ç½®
          fi
    
      - name: è®¾ç½®é»˜è®¤æ„å»ºè¯­è¨€
        run: |
            echo "BUILD_LOCALE=${{ github.event.inputs.build-language || 'en-US' }}" >> $GITHUB_ENV
      
      - name: è®¾ç½®é»˜è®¤æ„å»ºç¯å¢ƒ
        run: |
            echo "BUILD_ENV=${{ github.event.inputs.build-env || 'prod' }}" >> $GITHUB_ENV

      - name: è·å–ç¯å¢ƒå˜é‡
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_MODE_INPUT: ${{ env.BUILD_MODE_INPUT }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}
        run: |
          echo "BUILD_MODE=$BUILD_MODE, BUILD_MODE_INPUT=$BUILD_MODE_INPUT, BUILD_ENV=$BUILD_ENV, BUILD_LOCALE=$BUILD_LOCALE"

      # ------------- build apk -----------
      # Gradle ç¼“å­˜ (Android)
      - name: ç¼“å­˜ Gradle ä¾èµ–
        uses: actions/cache@v4
        with:
            path: ~/.gradle/caches
            key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
            restore-keys: |
                ${{ runner.os }}-gradle-
    
      # # è§£ç  Base64 ç¼–ç çš„ keystoreï¼Œå¹¶å­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶
      - name: è§£ç å¹¶ä¿å­˜å¯†é’¥åº“
        run: |
            echo ${{ secrets.ANDROID_ENCODED_KEYSTORE }} | base64 --decode > android/app/keystore.jks

      # Set up environment variables for signing config
      - name: è®¾ç½®ç¯å¢ƒï¼Œåˆ›å»º key.properties
        run: |
            cat <<EOF > android/key.properties
            KEYSTORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
            KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
            KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
            KEYSTORE_PATH=keystore.jks
            EOF

      - name: è¾“å‡º android/key.properties æ–‡ä»¶åˆ°æ—¥å¿—
        run: cat android/key.properties   

      # Build Android APK  && AAB
      - name: æ„å»º Android APK å’Œ AAB
        run: |
            echo "flutter build apk --$BUILD_MODE --dart-define=env=$BUILD_ENV --dart-define=locale=$BUILD_LOCALE"
            flutter build apk --$BUILD_MODE --dart-define=env=$BUILD_ENV --dart-define=locale=$BUILD_LOCALE
            echo "flutter build appbundle --$BUILD_MODE --dart-define=env=$BUILD_ENV --dart-define=locale=$BUILD_LOCALE"
            flutter build appbundle --$BUILD_MODE --dart-define=env=$BUILD_ENV --dart-define=locale=$BUILD_LOCALE
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}   

      # Archive android APK
      - name: å½’æ¡£ Android APK
        uses: actions/upload-artifact@v4
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}   
        with:
            name: android-${{ env.BUILD_MODE }}-${{ env.BUILD_ENV }}-${{ env.BUILD_LOCALE }}-apk
            path: build/app/outputs/flutter-apk/app-${{ env.BUILD_MODE }}.apk    
      
      # ä¸Šä¼  AAB æ–‡ä»¶
      - name: ä¸Šä¼  AAB
        uses: actions/upload-artifact@v4
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
          BUILD_ENV: ${{ env.BUILD_ENV }}
          BUILD_LOCALE: ${{ env.BUILD_LOCALE }}   
        with:
          name: android-${{ env.BUILD_MODE }}-${{ env.BUILD_ENV }}-${{ env.BUILD_LOCALE }}-aab
          path: build/app/outputs/bundle/${{ env.BUILD_MODE }}/app-${{ env.BUILD_MODE }}.aab
 
  orca-build:
    name: Orca æ„å»º
    if: ${{ contains(github.event.inputs.build-platform, 'orca') }}
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    steps:
      # æ£€å‡ºä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # è®¾ç½® Flutter ç¯å¢ƒ
      - name: è®¾ç½® Flutter ç¯å¢ƒ
        uses: subosito/flutter-action@v2
        with:
            flutter-version: '3.24.0'

      - run: flutter --version

      - name: è®¾ç½®é»˜è®¤æ„å»ºæ¨¡å¼
        run: |
          echo "BUILD_MODE=${{ github.event.inputs.build-mode || 'release' }}" >> $GITHUB_ENV
          # è®¾ç½®æ„å»ºæ¨¡å¼ï¼Œå¦‚æœè¾“å…¥ä¸º release-testing åˆ™ä½¿ç”¨ releaseï¼Œå¦åˆ™ä½¿ç”¨è¾“å…¥å€¼æˆ–é»˜è®¤å€¼
          BUILD_MODE_INPUT="${{ github.event.inputs.build-mode || 'release' }}"
          echo "BUILD_MODE_INPUT=$BUILD_MODE_INPUT" >> $GITHUB_ENV
          if [[ "$BUILD_MODE_INPUT" == "release-testing" ]]; then
            echo "BUILD_MODE=release" >> $GITHUB_ENV
          else
            echo "BUILD_MODE=$BUILD_MODE_INPUT" >> $GITHUB_ENV
            # å…¶ä»–é…ç½®åœ¨åç»­æ­¥éª¤ä¸­è®¾ç½®
          fi
          
      - name: è·å–ç¯å¢ƒå˜é‡
        run: |
          echo "BUILD_MODE=${{ env.BUILD_MODE }}, BUILD_MODE_INPUT=${{ env.BUILD_MODE_INPUT }}, BUILD_ENV=${{ env.BUILD_ENV }}, BUILD_LOCALE=${{ env.BUILD_LOCALE }}"
          
      # ä½¿ç”¨ npm è„šæœ¬æ„å»ºå’Œæ‰“åŒ…
      - name: ä½¿ç”¨ npm è„šæœ¬æ„å»ºå’Œæ‰“åŒ…
        env:
          BUILD_MODE: ${{ env.BUILD_MODE }}
        run: |
          cd orca
          echo "ä½¿ç”¨ $BUILD_MODE æ¨¡å¼æ„å»º Orca Web åº”ç”¨"
          
          # æ ¹æ®æ„å»ºæ¨¡å¼é€‰æ‹©å¯¹åº”çš„ npm è„šæœ¬
          case $BUILD_MODE in 
            profile)
              echo "æ‰§è¡Œ npm run build:web:profile:clearCache"
              npm run build:web:profile:clearCache
              ;;
            release)
              echo "æ‰§è¡Œ npm run build:web:release:clearCache"
              npm run build:web:release:clearCache
              ;;
            release-testing)
              echo "æ‰§è¡Œ npm run build:web:release:clearCache"
              npm run build:web:release:clearCache
              ;;
          esac
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æ–‡ä»¶ç³»ç»ŸåŒæ­¥
          sleep 2
          
          # è·å–ç‰ˆæœ¬å·ç”¨äºè®¾ç½®ç¯å¢ƒå˜é‡
          version=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          echo "å½“å‰ç‰ˆæœ¬å·: $version"
          
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "build ç›®å½•å†…å®¹:"
          ls -la build/ || echo "build ç›®å½•ä¸å­˜åœ¨"
          
          # æŸ¥æ‰¾å®é™…çš„ zip æ–‡ä»¶
          echo "æŸ¥æ‰¾ build ç›®å½•ä¸­çš„ zip æ–‡ä»¶:"
          find build/ -name "*.zip" -type f || echo "æœªæ‰¾åˆ° zip æ–‡ä»¶"
          
          # æ ¹æ®æ„å»ºæ¨¡å¼æŸ¥æ‰¾å¯¹åº”çš„ zip æ–‡ä»¶
          case $BUILD_MODE in
            release)
              zip_pattern="flutter_web_release_*.zip"
              ;;
            release-testing)
              zip_pattern="flutter_web_release_*.zip"
              ;;
            profile)
              zip_pattern="flutter_web_profile_*.zip"
              ;;
            debug)
              zip_pattern="flutter_web_debug_*.zip"
              ;;
          esac
          
          echo "æŸ¥æ‰¾æ¨¡å¼: $zip_pattern"
          actual_zip=$(find build/ -name "$zip_pattern" -type f | head -1)
          
          if [ -n "$actual_zip" ]; then
            echo "âœ… æ‰¾åˆ° zip æ–‡ä»¶: $actual_zip"
            echo "ORCA_ZIP_PATH=$(pwd)/$actual_zip" >> $GITHUB_ENV
            echo "ORCA_ZIP_NAME=$(basename $actual_zip)" >> $GITHUB_ENV
            pwd
          else
            echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„ zip æ–‡ä»¶"
            echo "å°è¯•æŸ¥æ‰¾ä»»ä½• zip æ–‡ä»¶..."
            any_zip=$(find build/ -name "*.zip" -type f | head -1)
            if [ -n "$any_zip" ]; then
              echo "æ‰¾åˆ°å…¶ä»– zip æ–‡ä»¶: $any_zip"
              echo "ORCA_ZIP_PATH=$any_zip" >> $GITHUB_ENV
              echo "ORCA_ZIP_NAME=$(basename $any_zip)" >> $GITHUB_ENV
            else
              echo "âŒ æœªæ‰¾åˆ°ä»»ä½• zip æ–‡ä»¶"
              exit 1
            fi
          fi

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: orca-${{ env.BUILD_MODE }}-build
          path: ${{ env.ORCA_ZIP_PATH }}
      
      - name: åˆ›å»ºç›®å½•ç»“æ„
        run: |
          cd orca/build/flutter_web
          mkdir -p flutter_web
          # å°†ç°æœ‰æ–‡ä»¶ç§»åŠ¨åˆ°æ–°åˆ›å»ºçš„ flutter_web å­ç›®å½•ä¸­
          if [ "$(ls -A . | grep -v flutter_web)" ]; then
            mv * flutter_web/ 2>/dev/null || true
          fi
          echo "ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ"
          ls -la

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ORCA_ZIP_NAME }}
          path: orca/build/flutter_web

  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-24.04
    needs: 
      - ios-build
      - android-build
      - orca-build
    steps:
      - name: é€šè¿‡é£ä¹¦åº”ç”¨é€šçŸ¥
        if: always()
        run: |
          # åˆå§‹åŒ–æ¶ˆæ¯å˜é‡
          # è®¡ç®—æˆåŠŸä»»åŠ¡æ•°
          SUCCESS_COUNT=0
          TOTAL_COUNT=0

          # æ£€æŸ¥ iOS æ„å»ºçŠ¶æ€
          if [[ "${{ contains(github.event.inputs.build-platform, 'ios') }}" == "true" ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            if [[ "${{ needs.ios-build.result }}" == "success" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          fi
          
          # æ£€æŸ¥ Android æ„å»ºçŠ¶æ€
          if [[ "${{ contains(github.event.inputs.build-platform, 'android') }}" == "true" ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            if [[ "${{ needs.android-build.result }}" == "success" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          fi
          
          # æ£€æŸ¥ Orca æ„å»ºçŠ¶æ€
          if [[ "${{ contains(github.event.inputs.build-platform, 'orca') }}" == "true" ]]; then
            TOTAL_COUNT=$((TOTAL_COUNT + 1))
            if [[ "${{ needs.orca-build.result }}" == "success" ]]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
          fi

          # æ„å»ºæ¶ˆæ¯
          message="ğŸš€ **Flutterå¤šå¹³å°æ„å»ºå®Œæˆ**\n\n"
          message+="**ğŸ“Š æ„å»ºæ‘˜è¦**\n"
          message+="â€¢ æˆåŠŸæ•°: $SUCCESS_COUNT/$TOTAL_COUNT\n"
          message+="â€¢ æ„å»ºæ¨¡å¼: ${{ github.event.inputs.build-mode || 'profile' }}\n"
          message+="â€¢ æ„å»ºç¯å¢ƒ: ${{ github.event.inputs.build-env || 'prod' }}\n"
          message+="â€¢ æ„å»ºè¯­è¨€: ${{ github.event.inputs.build-language || 'en-US' }}\n\n"
          
          message+="**ğŸ”§ è¯¦ç»†ç»“æœ**\n"
          
          # æ£€æŸ¥å„å¹³å°æ„å»ºçŠ¶æ€
          if [[ "${{ contains(github.event.inputs.build-platform, 'ios') }}" == "true" ]]; then
            if [[ "${{ needs.ios-build.result }}" == "success" ]]; then
              message+="â€¢ iOS: âœ… æˆåŠŸ\n"
            else
              message+="â€¢ iOS: âŒ å¤±è´¥\n"
            fi
          fi
          
          if [[ "${{ contains(github.event.inputs.build-platform, 'android') }}" == "true" ]]; then
            if [[ "${{ needs.android-build.result }}" == "success" ]]; then
              message+="â€¢ Android: âœ… æˆåŠŸ\n"
            else
              message+="â€¢ Android: âŒ å¤±è´¥\n"
            fi
          fi
          
          if [[ "${{ contains(github.event.inputs.build-platform, 'orca') }}" == "true" ]]; then
            if [[ "${{ needs.orca-build.result }}" == "success" ]]; then
              message+="â€¢ Orca Web: âœ… æˆåŠŸ\n"
            else
              message+="â€¢ Orca Web: âŒ å¤±è´¥\n"
            fi
          fi
          
          message+="\n**ğŸ”— ç›¸å…³é“¾æ¥**\n"
          message+="[æŸ¥çœ‹æ„å»ºè¯¦æƒ…](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n"
          message+="[ä¸‹è½½æ„å»ºäº§ç‰©](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)\n"
          
          echo "message: $message"
      
          curl -X POST "$FEISHU_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "'"$message"'"
              }
            }'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        
