name: Flutter CI/CD
# base64 -i PROVISIONING_PROFILE.mobileprovision | pbcopy
on:
  # watch:
  #   types: started
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 60
    steps:
      # 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Java for Android build
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'  # or '11'

      # 设置 Flutter 环境
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.3'
    
      # 在构建之前执行 flutter clean
      - name: Flutter Clean
        run: flutter clean

      # flutter pub get
      - name: Install dependencies
        run: flutter pub get
    
      # # Gradle 缓存 (Android)
      # - name: Cache Gradle dependencies
      #   uses: actions/cache@v2
      #   with:
      #     path: ~/.gradle/caches
      #     key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
      #     restore-keys: |
      #       ${{ runner.os }}-gradle-
      
      # # Build Android APK
      # - name: Build Android APK
      #   run: flutter build apk --release
      
      # # Archive android APK
      # - name: Archive android APK
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: android-apk
      #     path: build/app/outputs/flutter-apk/app-release.apk    
       
      # 缓存 CocoaPods
      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ios/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      # 设置 Ruby 和 CocoaPods 环境
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'  # 根据项目需要调整版本

      - name: Install Pods
        run: pod install --no-repo-update
        working-directory: ios
      
      # 清理构建目录
      - name: Clean DerivedData
        run: rm -rf ~/Library/Developer/Xcode/DerivedData

      # 导入证书并解锁密钥链
      - name: Install Apple Certificates
        run: |
          echo "*****Decoding IOS_CERTIFICATE and setting up keychain"
          echo "$IOS_CERTIFICATE" | base64 --decode > /tmp/certificate.p12
          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" build.keychain
          security import /tmp/certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-keychain-settings -t 3600 -l ~/Library/Keychains/build.keychain
          security list-keychains -s ~/Library/Keychains/build.keychain
          security unlock-keychain -p "$IOS_CERTIFICATE_PASSWORD" ~/Library/Keychains/build.keychain
        # 通过 env 传递 GitHub Secrets
        env:
          IOS_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}

      # 安装描述文件
      - name: Install Apple Provisioning Profile
        run: |
          echo "*****Decoding IOS_CERTIFICATE and setting up keychain"
          echo "$IOS_PROVISIONING_PROFILE" | base64 --decode > /tmp/profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
        # 通过 env 传递 GitHub Secrets IOS_PROVISIONING_PROFILE使用adhoc/appstore文件
        env:
          IOS_PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          
      # Create ExportOptions.plist <!- `{app-store-connect, release-testing, enterprise, debugging, validation}` 是用于 `method` 的一些常见值 -->
      # - name: Create Apple ExportOptions.plist
      #   run: |
      #     echo '<?xml version="1.0" encoding="UTF-8"?>
      #           <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      #           <plist version="1.0">
      #           <dict>
      #               <key>compileBitcode</key>
      #               <false/>
      #               <key>destination</key>
      #               <string>export</string>
      #               <key>method</key>
      #               <string>release-testing</string>
      #               <key>signingStyle</key>
      #               <string>automatic</string>
      #               <key>stripSwiftSymbols</key>
      #               <true/>
      #               <key>teamID</key>
      #               <string>"$TEAM_ID"</string>
      #               <key>thinning</key>
      #               <string>&lt;none&gt;</string>
      #           </dict>
      #           </plist>' > ExportOptions.plist
      #   env:
      #     TEAM_ID: ${{ secrets.TEAM_ID }}
      
      # 构建 iOS 应用
      # 归档项目（.xcarchive 文件）
      # 清理之前的构建,完成后 再清理
      # Build ios archive 自动签名后面加入-allowProvisioningUpdates
      # - name: flutter build ios export .app文件
      #   run: |
      #     flutter build ios --release --no-codesign
       # Build the iOS app
      - name: Build iOS App
        run: flutter build ios --release --no-codesign

      # Set up Apple Certificate and Profile for signing
      - name: Set up Signing Certificates and Provisioning Profiles
        uses: apple-actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.IOS_CERTIFICATE }}
          p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          provisioning-profile-base64: ${{ secrets.IOS_PROVISIONING_PROFILE }}
          keychain: 'tempkeychain'
          keychain-password: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}

      # Archive the iOS app for deployment or further actions
      - name: Archive the iOS App
        run: |
          xcodebuild \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -sdk iphoneos \
            -configuration Release \
            archive \
            -archivePath $PWD/build/Runner.xcarchive

      # Export IPA (optional)
      - name: Export IPA
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath $PWD/build/Runner.xcarchive \
            -exportOptionsPlist ios/ExportOptions.plist \
            -exportPath $PWD/build/Runner.ipa
      
      - name: Build iOS app with code signing
        run: |
          flutter build ios --release --no-codesign
          xcodebuild \
            -workspace ios/Runner.xcworkspace \
            -scheme Runner \
            -sdk iphoneos \
            -configuration Release \
            -allowProvisioningUpdates \
            archive -archivePath build/ios/Runner.xcarchive
      - name: Export the signed IPA
        run: |
         xcodebuild \
          -exportArchive \
          -archivePath build/ios/Runner.xcarchive \
          -exportOptionsPlist ios/Runner/ExportOptions.plist \
          -exportPath build/ios
    
      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: ios-build
          path: build/ios/*.ipa

      # flutter build ipa  --export-method: ad-hoc, development, enterprise
      # - name: Flutter build ipa and Export iOS IPA
      #   run: |
      #     flutter build ipa --release --export-options-plist=ExportOptions-signingCertificate.plist            
    
      # # Upload the exported IPA file
      # - name: Upload IOS .ipa to artifacts
      #   uses: actions/upload-artifact@v3
      #   with:
      #     name: ios-ipa
      #     path: build/ios/ipa/Runner.ipa
      
      # Ensure this step only runs after the build process to avoid deleting necessary certificates too early
      # - name: Delete certificates
      #   run: |
      #     rm -f /tmp/certificate.p12
      #     rm -f /tmp/profile.mobileprovision
    
  notify:
    runs-on: ubuntu-latest
    # needs: [android-deploy, ios-deploy]  # 依赖于 android-deploy 和 ios-deploy 的执行结果
    steps:
      # always() / success() || failure() 不论前面的 job 成功或失败都会执行
      - name: Notify via Feishu
        if: success()
        run: |
          curl -X POST "$FEISHU_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
            "msg_type": "text",
            "content": {
              "text": "CI/CD Job Status: \nAndroid Job: ${{ needs.android-deploy.result }} \niOS Job: ${{ needs.ios-deploy.result }}\nDetails: ${{ github.server_url }}/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
            }
          }'
        env:
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
